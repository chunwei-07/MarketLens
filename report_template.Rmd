---
title: "MarketLens Stock Analysis Report"
output: pdf_document
params:
    ticker: "AAPL"
    stock_data: NULL
    forecast_results: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(dplyr)
library(knitr)
```

## Stock Analysis for `r params$ticker`

This report provides a summary of the historical performance and forecast for the stock ticker **`r params$ticker`**.
The analysis covers the period from `r min(params$stock_data$date)` to `r max(params$stock_data$date)`.

## Historical Price Chart

Here is the historical performance of the adjusted closing price.

```{r price_chart}
ggplot(params$stock_data, aes(x = date, y = adjusted)) +
    geom_line(color = "#39a263") +
    labs(
        title = paste("Historical Adjusted Price for", params$ticker),
        x = "Date",
        y = "Adjusted Price"
    ) +
    theme_minimal()
```

## Forecast Analysis

A short-term forecast was generated for the next period.

```{r forecast_data}
# Combine historical and forecast data for plotting
historical_df <- params$stock_data %>% select(date, adjusted) %>% mutate(type = "Actual")
forecast_df <- params$forecast_results$data %>%
    select(date, point_forecast) %>%
    rename(adjusted = point_forecast) %>%
    mutate(type = "Forecast")

combined_df <- bind_rows(historical_df, forecast_df)

ggplot(combined_df, aes(x = date, y = adjusted, color = type)) +
    geom_line() +
    scale_color_manual(values = c("Actual" = "black", "Forecast" = "#39a263")) +
    labs(
        title = paste("Forecast for", params$ticker),
        x = "Date",
        y = "Adjusted Price",
        color = "Data Type"
    ) +
    theme_minimal()
```

## Model Performance Metrics

The following error metrics were calculated for the forecast model. Lower values are generally better.

```{r metrics_table}
kable(params$forecast_results$metrics, caption = "Forecast Error Metrics", digits = 3)
```